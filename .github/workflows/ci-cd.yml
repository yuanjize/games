name: CI/CD Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  # ==================== 测试 Job ====================
  test:
    name: 运行测试
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 运行测试（当配置完成后）
        run: echo "测试配置待添加，跳过测试步骤"
        continue-on-error: true

      - name: 代码检查（当配置完成后）
        run: echo "ESLint配置待添加，跳过代码检查"
        continue-on-error: true

  # ==================== 构建 Job ====================
  build:
    name: 构建项目
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 使用 Vite 构建
        run: npm run build:vite
        continue-on-error: true

      - name: 使用传统脚本构建（备用）
        run: npm run build

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

      - name: 生成构建报告
        run: |
          echo "## 构建信息" >> $GITHUB_STEP_SUMMARY
          echo "- **时间**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **提交**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **分支**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY || true

  # ==================== 部署 Job ====================
  deploy:
    name: 部署到 Cloudflare Pages
    needs: build
    runs-on: ubuntu-latest
    # 仅在 master/main 分支推送时部署
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: 部署到 Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: games-collection
          directory: dist
          # Git 部署配置
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          wranglerVersion: '3'

      - name: 部署摘要
        run: |
          echo "## 部署成功" >> $GITHUB_STEP_SUMMARY
          echo "✅ 项目已成功部署到 Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "- **项目**: games-collection" >> $GITHUB_STEP_SUMMARY
          echo "- **提交**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ==================== PR 评论 Job ====================
  pr-comment:
    name: PR 部署预览
    needs: build
    runs-on: ubuntu-latest
    # 仅在 PR 时运行
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: 部署预览到 Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: games-collection
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          wranglerVersion: '3'

      - name: 评论 PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **部署预览已生成！**

              - 预览环境已部署
              - 提交: \`${{ github.sha }}\`
              - 分支: \`${context.ref}\`

              请查看 Cloudflare Pages 控制台获取预览链接。`
            })
