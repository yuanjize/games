<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç –å—æ¸¸æˆæµ‹è¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
        }
        h1 { color: #3498db; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            color: #f39c12;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #0f3460;
            border-radius: 4px;
        }
        .test-item.pass { border-left: 4px solid #2ecc71; }
        .test-item.fail { border-left: 4px solid #e74c3c; }
        .test-item.pending { border-left: 4px solid #95a5a6; }
        .test-status {
            width: 80px;
            font-weight: bold;
        }
        .test-status.pass { color: #2ecc71; }
        .test-status.fail { color: #e74c3c; }
        .test-status.pending { color: #95a5a6; }
        .test-desc { flex: 1; }
        .btn {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { background: #2980b9; }
        .btn.success { background: #2ecc71; }
        .btn.danger { background: #e74c3c; }
        .console-output {
            background: #0a0a0a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .game-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .info-box {
            background: #0f3460;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .info-label { color: #95a5a6; font-size: 12px; }
        .info-value { color: #3498db; font-size: 24px; font-weight: bold; }
        .hidden { display: none; }
        iframe {
            width: 100%;
            height: 700px;
            border: none;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ‰“ç –å—æ¸¸æˆè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·</h1>

        <!-- æ¸¸æˆé¢„è§ˆ -->
        <div class="test-section">
            <h2>æ¸¸æˆé¢„è§ˆ</h2>
            <iframe id="gameFrame" src="index.html"></iframe>
        </div>

        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="test-section">
            <h2>æµ‹è¯•æ§åˆ¶</h2>
            <button class="btn" onclick="runAllTests()">â–¶ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="btn" onclick="runBasicTests()">ğŸ“‹ åŸºç¡€åŠŸèƒ½æµ‹è¯•</button>
            <button class="btn" onclick="runGameplayTests()">ğŸ® æ¸¸æˆç©æ³•æµ‹è¯•</button>
            <button class="btn danger" onclick="resetTests()">ğŸ”„ é‡ç½®æµ‹è¯•</button>
        </div>

        <!-- å®æ—¶æ¸¸æˆçŠ¶æ€ -->
        <div class="test-section">
            <h2>å®æ—¶æ¸¸æˆçŠ¶æ€</h2>
            <div class="game-info">
                <div class="info-box">
                    <div class="info-label">æ¸¸æˆçŠ¶æ€</div>
                    <div class="info-value" id="info-state">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">å¾—åˆ†</div>
                    <div class="info-value" id="info-score">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">ç”Ÿå‘½</div>
                    <div class="info-value" id="info-lives">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">å…³å¡</div>
                    <div class="info-value" id="info-level">-</div>
                </div>
            </div>
            <div class="game-info" style="margin-top: 15px;">
                <div class="info-box">
                    <div class="info-label">çƒæ•°é‡</div>
                    <div class="info-value" id="info-balls">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">å¯è§ç –å—</div>
                    <div class="info-value" id="info-bricks">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">é“å…·æ•°é‡</div>
                    <div class="info-value" id="info-powerups">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">ç²’å­æ•°é‡</div>
                    <div class="info-value" id="info-particles">-</div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h2>æµ‹è¯•ç»“æœ</h2>
            <div id="test-results"></div>
        </div>

        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="test-section">
            <h2>æµ‹è¯•æ—¥å¿—</h2>
            <div class="console-output" id="console-output">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
    </div>

    <script>
        const gameFrame = document.getElementById('gameFrame');
        const consoleOutput = document.getElementById('console-output');
        const testResults = document.getElementById('test-results');

        let gameWindow = null;
        let testCount = 0;
        let passedTests = 0;
        let failedTests = 0;

        // ç­‰å¾…æ¸¸æˆåŠ è½½
        function waitForGame() {
            return new Promise((resolve) => {
                const checkGame = () => {
                    try {
                        if (gameFrame.contentWindow && gameFrame.contentWindow.brickBreakerGame) {
                            gameWindow = gameFrame.contentWindow;
                            resolve(gameWindow.brickBreakerGame);
                        } else {
                            setTimeout(checkGame, 100);
                        }
                    } catch (e) {
                        setTimeout(checkGame, 100);
                    }
                };
                checkGame();
            });
        }

        // æ—¥å¿—è¾“å‡º
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                'info': 'â„¹ï¸',
                'pass': 'âœ…',
                'fail': 'âŒ',
                'warn': 'âš ï¸',
                'test': 'ğŸ§ª'
            };
            const icon = icons[type] || 'â€¢';
            consoleOutput.textContent += `[${timestamp}] ${icon} ${msg}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            consoleOutput.textContent = '';
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(name, passed, message = '') {
            testCount++;
            if (passed) passedTests++; else failedTests++;

            const div = document.createElement('div');
            div.className = `test-item ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <span class="test-status ${passed ? 'pass' : 'fail'}">${passed ? 'PASS' : 'FAIL'}</span>
                <span class="test-desc">${name}${message ? ' - ' + message : ''}</span>
            `;
            testResults.appendChild(div);
        }

        // é‡ç½®æµ‹è¯•
        function resetTests() {
            testCount = 0;
            passedTests = 0;
            failedTests = 0;
            testResults.innerHTML = '';
            clearLog();
            log('æµ‹è¯•å·²é‡ç½®', 'info');
        }

        // è·å–æ¸¸æˆçŠ¶æ€
        function getGameState() {
            if (!gameWindow || !gameWindow.brickBreakerGame) return null;
            const game = gameWindow.brickBreakerGame;
            return {
                state: game.state,
                score: game.score,
                lives: game.lives,
                level: game.level,
                balls: game.balls ? game.balls.length : 0,
                visibleBricks: game.bricks ? game.bricks.filter(b => b.visible).length : 0,
                powerups: game.powerups ? game.powerups.length : 0,
                particles: game.particles ? game.particles.length : 0,
                paddleWidth: game.paddle ? game.paddle.width : 0
            };
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStateDisplay() {
            const state = getGameState();
            if (!state) return;

            document.getElementById('info-state').textContent = state.state || '-';
            document.getElementById('info-score').textContent = state.score;
            document.getElementById('info-lives').textContent = state.lives;
            document.getElementById('info-level').textContent = state.level;
            document.getElementById('info-balls').textContent = state.balls;
            document.getElementById('info-bricks').textContent = state.visibleBricks;
            document.getElementById('info-powerups').textContent = state.powerups;
            document.getElementById('info-particles').textContent = state.particles;
        }

        // åŸºç¡€åŠŸèƒ½æµ‹è¯•
        async function runBasicTests() {
            clearLog();
            log('å¼€å§‹åŸºç¡€åŠŸèƒ½æµ‹è¯•...', 'test');

            const game = await waitForGame();
            log('æ¸¸æˆå·²åŠ è½½', 'pass');

            // æµ‹è¯•1: åˆå§‹çŠ¶æ€
            log('æµ‹è¯•1: æ£€æŸ¥åˆå§‹çŠ¶æ€', 'test');
            if (game.score === 0 && game.lives === 3 && game.level === 1) {
                addTestResult('åˆå§‹çŠ¶æ€æ£€æŸ¥', true, `å¾—åˆ†=0, ç”Ÿå‘½=3, å…³å¡=1`);
                log('åˆå§‹çŠ¶æ€æ­£ç¡®', 'pass');
            } else {
                addTestResult('åˆå§‹çŠ¶æ€æ£€æŸ¥', false, `å¾—åˆ†=${game.score}, ç”Ÿå‘½=${game.lives}, å…³å¡=${game.level}`);
                log('åˆå§‹çŠ¶æ€é”™è¯¯', 'fail');
            }

            // æµ‹è¯•2: å¼€å§‹æ¸¸æˆ
            log('æµ‹è¯•2: å¼€å§‹æ¸¸æˆ', 'test');
            game.startGame();
            await sleep(200);
            if (game.state === 'playing') {
                addTestResult('å¼€å§‹æ¸¸æˆ', true);
                log('æ¸¸æˆæˆåŠŸè¿›å…¥PLAYINGçŠ¶æ€', 'pass');
            } else {
                addTestResult('å¼€å§‹æ¸¸æˆ', false, `çŠ¶æ€=${game.state}`);
                log('æ¸¸æˆçŠ¶æ€é”™è¯¯', 'fail');
            }

            // æµ‹è¯•3: å‘å°„çƒ
            log('æµ‹è¯•3: å‘å°„çƒ', 'test');
            if (game.balls && game.balls.length > 0) {
                game.launchBall();
                await sleep(200);
                if (game.balls[0].launched) {
                    addTestResult('çƒå‘å°„', true);
                    log('çƒæˆåŠŸå‘å°„', 'pass');
                } else {
                    addTestResult('çƒå‘å°„', false, 'çƒæœªå‘å°„');
                    log('çƒæœªèƒ½å‘å°„', 'fail');
                }
            } else {
                addTestResult('çƒå‘å°„', false, 'çƒä¸å­˜åœ¨');
                log('çƒå¯¹è±¡ä¸å­˜åœ¨', 'fail');
            }

            // æµ‹è¯•4: æš‚åœæ¸¸æˆ
            log('æµ‹è¯•4: æš‚åœæ¸¸æˆ', 'test');
            game.pauseGame();
            await sleep(100);
            if (game.state === 'paused') {
                addTestResult('æš‚åœæ¸¸æˆ', true);
                log('æ¸¸æˆæˆåŠŸæš‚åœ', 'pass');
            } else {
                addTestResult('æš‚åœæ¸¸æˆ', false, `çŠ¶æ€=${game.state}`);
                log('æš‚åœçŠ¶æ€é”™è¯¯', 'fail');
            }

            // æµ‹è¯•5: æ¢å¤æ¸¸æˆ
            log('æµ‹è¯•5: æ¢å¤æ¸¸æˆ', 'test');
            game.resumeGame();
            await sleep(100);
            if (game.state === 'playing') {
                addTestResult('æ¢å¤æ¸¸æˆ', true);
                log('æ¸¸æˆæˆåŠŸæ¢å¤', 'pass');
            } else {
                addTestResult('æ¢å¤æ¸¸æˆ', false, `çŠ¶æ€=${game.state}`);
                log('æ¢å¤çŠ¶æ€é”™è¯¯', 'fail');
            }

            // æµ‹è¯•6: ç –å—åˆå§‹åŒ–
            log('æµ‹è¯•6: ç –å—åˆå§‹åŒ–', 'test');
            const totalBricks = game.bricks ? game.bricks.length : 0;
            const visibleBricks = game.bricks ? game.bricks.filter(b => b.visible).length : 0;
            if (totalBricks === 60 && visibleBricks === 60) {
                addTestResult('ç –å—åˆå§‹åŒ–', true, `60ä¸ªç –å—å…¨éƒ¨å¯è§`);
                log('ç –å—åˆå§‹åŒ–æ­£ç¡®', 'pass');
            } else {
                addTestResult('ç –å—åˆå§‹åŒ–', false, `æ€»æ•°=${totalBricks}, å¯è§=${visibleBricks}`);
                log('ç –å—åˆå§‹åŒ–å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•7: ç –å—ç±»å‹
            log('æµ‹è¯•7: ç –å—ç±»å‹', 'test');
            const normalBricks = game.bricks.filter(b => b.type === 'normal').length;
            const strongBricks = game.bricks.filter(b => b.type === 'strong').length;
            const specialBricks = game.bricks.filter(b => b.type === 'special').length;
            if (normalBricks > 0 && strongBricks > 0 && specialBricks > 0) {
                addTestResult('ç –å—ç±»å‹åˆ†å¸ƒ', true, `æ™®é€š=${normalBricks}, åšå›º=${strongBricks}, ç‰¹æ®Š=${specialBricks}`);
                log('ç –å—ç±»å‹åˆ†å¸ƒæ­£ç¡®', 'pass');
            } else {
                addTestResult('ç –å—ç±»å‹åˆ†å¸ƒ', false, `æ™®é€š=${normalBricks}, åšå›º=${strongBricks}, ç‰¹æ®Š=${specialBricks}`);
                log('ç –å—ç±»å‹åˆ†å¸ƒå¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•8: æŒ¡æ¿åˆå§‹åŒ–
            log('æµ‹è¯•8: æŒ¡æ¿åˆå§‹åŒ–', 'test');
            if (game.paddle && game.paddle.width === 100) {
                addTestResult('æŒ¡æ¿åˆå§‹åŒ–', true, `å®½åº¦=${game.paddle.width}`);
                log('æŒ¡æ¿åˆå§‹åŒ–æ­£ç¡®', 'pass');
            } else {
                addTestResult('æŒ¡æ¿åˆå§‹åŒ–', false, `å®½åº¦=${game.paddle ? game.paddle.width : 'undefined'}`);
                log('æŒ¡æ¿åˆå§‹åŒ–å¯èƒ½æœ‰é—®é¢˜', 'fail');
            }

            log('åŸºç¡€åŠŸèƒ½æµ‹è¯•å®Œæˆ!', 'test');
        }

        // æ¸¸æˆç©æ³•æµ‹è¯•
        async function runGameplayTests() {
            clearLog();
            log('å¼€å§‹æ¸¸æˆç©æ³•æµ‹è¯•...', 'test');

            const game = await waitForGame();
            log('æ¸¸æˆå·²åŠ è½½', 'pass');

            // é‡ç½®æ¸¸æˆ
            game.resetGame();
            await sleep(100);
            game.startGame();
            await sleep(100);

            // æµ‹è¯•1: é”®ç›˜æ§åˆ¶
            log('æµ‹è¯•1: é”®ç›˜æ§åˆ¶æŒ¡æ¿', 'test');
            const initialX = game.paddle.x;
            gameFrame.contentWindow.dispatchEvent(new KeyboardEvent('keydown', { code: 'ArrowRight' }));
            await sleep(50);
            const newX = game.paddle.x;
            if (newX > initialX) {
                addTestResult('é”®ç›˜æ§åˆ¶', true, `æŒ¡æ¿ç§»åŠ¨äº† ${newX - initialX}px`);
                log('é”®ç›˜æ§åˆ¶æ­£å¸¸', 'pass');
            } else {
                addTestResult('é”®ç›˜æ§åˆ¶', false, 'æŒ¡æ¿æœªç§»åŠ¨');
                log('é”®ç›˜æ§åˆ¶å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•2: ç –å—ç¢°æ’æ¨¡æ‹Ÿ
            log('æµ‹è¯•2: æ¨¡æ‹Ÿç –å—ç¢°æ’', 'test');
            if (game.balls.length > 0) {
                const ball = game.balls[0];
                const brick = game.bricks.find(b => b.visible);
                if (brick) {
                    // å°†çƒç§»åŠ¨åˆ°ç –å—ä½ç½®
                    ball.x = brick.x + brick.width / 2;
                    ball.y = brick.y + brick.height + ball.radius + 1;
                    ball.dy = 2;
                    ball.launched = true;
                    game.update();
                    await sleep(50);

                    const hitBrick = game.bricks.find(b => b.x === brick.x && b.y === brick.y);
                    if (!hitBrick.visible || hitBrick.hits < brick.hits) {
                        addTestResult('ç –å—ç¢°æ’', true, 'ç –å—è¢«å‡»ä¸­');
                        log('ç –å—ç¢°æ’æ£€æµ‹æ­£å¸¸', 'pass');
                    } else {
                        addTestResult('ç –å—ç¢°æ’', false, 'ç –å—æœªè¢«å‡»ä¸­');
                        log('ç –å—ç¢°æ’æ£€æµ‹å¯èƒ½æœ‰é—®é¢˜', 'warn');
                    }
                }
            }

            // æµ‹è¯•3: æŒ¡æ¿ç¢°æ’æ¨¡æ‹Ÿ
            log('æµ‹è¯•3: æ¨¡æ‹ŸæŒ¡æ¿ç¢°æ’', 'test');
            if (game.balls.length > 0) {
                const ball = game.balls[0];
                const oldDY = ball.dy;
                ball.x = game.paddle.x + game.paddle.width / 2;
                ball.y = game.paddle.y - ball.radius - 1;
                ball.dy = 2;
                ball.launched = true;
                game.update();
                await sleep(50);

                if (ball.dy < 0) {
                    addTestResult('æŒ¡æ¿ç¢°æ’', true, 'çƒå‘ä¸Šåå¼¹');
                    log('æŒ¡æ¿ç¢°æ’æ£€æµ‹æ­£å¸¸', 'pass');
                } else {
                    addTestResult('æŒ¡æ¿ç¢°æ’', false, `dy=${ball.dy}`);
                    log('æŒ¡æ¿ç¢°æ’æ£€æµ‹å¯èƒ½æœ‰é—®é¢˜', 'warn');
                }
            }

            // æµ‹è¯•4: é“å…·åˆ›å»º
            log('æµ‹è¯•4: é“å…·åˆ›å»º', 'test');
            const powerupCountBefore = game.powerups.length;
            game.createPowerup(400, 300);
            await sleep(50);
            if (game.powerups.length > powerupCountBefore) {
                addTestResult('é“å…·åˆ›å»º', true, `åˆ›å»ºäº† ${game.powerups.length - powerupCountBefore} ä¸ªé“å…·`);
                log('é“å…·åˆ›å»ºæ­£å¸¸', 'pass');
            } else {
                addTestResult('é“å…·åˆ›å»º', false, 'é“å…·æœªåˆ›å»º');
                log('é“å…·åˆ›å»ºå¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•5: é“å…·åº”ç”¨
            log('æµ‹è¯•5: é“å…·åº”ç”¨', 'test');
            const oldWidth = game.paddle.width;
            game.applyPowerup('PADDLE_LONG');
            await sleep(50);
            if (game.paddle.width > oldWidth) {
                addTestResult('åŠ é•¿æŒ¡æ¿é“å…·', true, `å®½åº¦ä» ${oldWidth} å˜ä¸º ${game.paddle.width}`);
                log('åŠ é•¿æŒ¡æ¿é“å…·æ­£å¸¸', 'pass');
            } else {
                addTestResult('åŠ é•¿æŒ¡æ¿é“å…·', false, `å®½åº¦æœªå˜åŒ–: ${oldWidth}`);
                log('åŠ é•¿æŒ¡æ¿é“å…·å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•6: å¤šçƒé“å…·
            log('æµ‹è¯•6: å¤šçƒé“å…·', 'test');
            const ballCountBefore = game.balls.length;
            game.balls[0].launched = true;
            game.balls[0].dx = 2;
            game.balls[0].dy = -2;
            game.applyPowerup('MULTI_BALL');
            await sleep(50);
            if (game.balls.length > ballCountBefore) {
                addTestResult('å¤šçƒé“å…·', true, `çƒæ•°ä» ${ballCountBefore} å˜ä¸º ${game.balls.length}`);
                log('å¤šçƒé“å…·æ­£å¸¸', 'pass');
            } else {
                addTestResult('å¤šçƒé“å…·', false, `çƒæ•°æœªå˜åŒ–: ${game.balls.length}`);
                log('å¤šçƒé“å…·å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•7: ç²’å­åˆ›å»º
            log('æµ‹è¯•7: ç²’å­æ•ˆæœ', 'test');
            const particleCountBefore = game.particles.length;
            game.createParticles(400, 300, 10, '#ff0000');
            await sleep(50);
            if (game.particles.length >= particleCountBefore + 10) {
                addTestResult('ç²’å­æ•ˆæœ', true, `åˆ›å»ºäº† ${game.particles.length - particleCountBefore} ä¸ªç²’å­`);
                log('ç²’å­æ•ˆæœæ­£å¸¸', 'pass');
            } else {
                addTestResult('ç²’å­æ•ˆæœ', false, `åªåˆ›å»ºäº† ${game.particles.length - particleCountBefore} ä¸ªç²’å­`);
                log('ç²’å­æ•ˆæœå¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•8: çƒæ‰è½æ£€æµ‹
            log('æµ‹è¯•8: çƒæ‰è½æ£€æµ‹', 'test');
            const livesBefore = game.lives;
            if (game.balls.length > 0) {
                game.balls[0].y = 700; // è¶…å‡ºç”»å¸ƒ
                game.update();
                await sleep(50);
                if (game.balls.length === 0 && game.lives === livesBefore - 1) {
                    addTestResult('çƒæ‰è½æ£€æµ‹', true, 'ç”Ÿå‘½å‡å°‘1');
                    log('çƒæ‰è½æ£€æµ‹æ­£å¸¸', 'pass');
                } else {
                    addTestResult('çƒæ‰è½æ£€æµ‹', false, `çƒæ•°=${game.balls.length}, ç”Ÿå‘½=${game.lives}`);
                    log('çƒæ‰è½æ£€æµ‹å¯èƒ½æœ‰é—®é¢˜', 'warn');
                }
            }

            // æµ‹è¯•9: å…³å¡å®Œæˆ
            log('æµ‹è¯•9: å…³å¡å®Œæˆæ£€æµ‹', 'test');
            game.bricks.forEach(b => b.visible = false);
            game.update();
            await sleep(100);
            if (game.state === 'level_complete') {
                addTestResult('å…³å¡å®Œæˆ', true);
                log('å…³å¡å®Œæˆæ£€æµ‹æ­£å¸¸', 'pass');
            } else {
                addTestResult('å…³å¡å®Œæˆ', false, `çŠ¶æ€=${game.state}`);
                log('å…³å¡å®Œæˆæ£€æµ‹å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•10: ä¸‹ä¸€å…³
            log('æµ‹è¯•10: ä¸‹ä¸€å…³åŠŸèƒ½', 'test');
            const levelBefore = game.level;
            game.nextLevel();
            await sleep(100);
            if (game.level === levelBefore + 1) {
                addTestResult('ä¸‹ä¸€å…³', true, `å…³å¡ä» ${levelBefore} å‡çº§åˆ° ${game.level}`);
                log('ä¸‹ä¸€å…³åŠŸèƒ½æ­£å¸¸', 'pass');
            } else {
                addTestResult('ä¸‹ä¸€å…³', false, `å…³å¡=${game.level}`);
                log('ä¸‹ä¸€å…³åŠŸèƒ½å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            // æµ‹è¯•11: æ¸¸æˆç»“æŸ
            log('æµ‹è¯•11: æ¸¸æˆç»“æŸ', 'test');
            game.lives = 0;
            game.balls = [];
            game.update();
            await sleep(100);
            if (game.state === 'game_over') {
                addTestResult('æ¸¸æˆç»“æŸ', true);
                log('æ¸¸æˆç»“æŸæ£€æµ‹æ­£å¸¸', 'pass');
            } else {
                addTestResult('æ¸¸æˆç»“æŸ', false, `çŠ¶æ€=${game.state}`);
                log('æ¸¸æˆç»“æŸæ£€æµ‹å¯èƒ½æœ‰é—®é¢˜', 'warn');
            }

            log('æ¸¸æˆç©æ³•æµ‹è¯•å®Œæˆ!', 'test');
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            resetTests();
            await runBasicTests();
            await sleep(500);
            await runGameplayTests();

            // æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
            log('='.repeat(50), 'info');
            log(`æµ‹è¯•æ€»ç»“: æ€»è®¡ ${testCount}, é€šè¿‡ ${passedTests}, å¤±è´¥ ${failedTests}`, 'test');
            log('='.repeat(50), 'info');
        }

        // è¾…åŠ©å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€æ˜¾ç¤º
        setInterval(() => {
            updateStateDisplay();
        }, 500);

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨ç­‰å¾…æ¸¸æˆ
        window.addEventListener('load', () => {
            log('æµ‹è¯•å·¥å…·å·²åŠ è½½ï¼Œç­‰å¾…æ¸¸æˆåˆå§‹åŒ–...', 'info');
            waitForGame().then(() => {
                log('æ¸¸æˆå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•!', 'pass');
            });
        });
    </script>
</body>
</html>
