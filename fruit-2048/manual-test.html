<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æœ2048 - æ‰‹åŠ¨æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .test-section {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            margin-bottom: 15px;
            color: #8b5cf6;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 200px;
            margin: 10px 0;
        }
        .test-cell {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .test-btn {
            padding: 10px 20px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .test-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }
        .test-btn:active {
            transform: translateY(0);
        }
        .test-btn.success {
            background: #10b981;
        }
        .test-btn.error {
            background: #ef4444;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        .result.pass {
            border-left: 4px solid #10b981;
        }
        .result.fail {
            border-left: 4px solid #ef4444;
        }
        .iframe-container {
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            overflow: hidden;
            height: 700px;
            margin-top: 20px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-badge.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        .status-badge.passed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .status-badge.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ°´æœ2048 - æ‰‹åŠ¨æµ‹è¯•å·¥å…·</h1>

        <div class="test-section">
            <h2>æ¸¸æˆé¢„è§ˆ <span class="status-badge pending" id="game-status">å¾…æµ‹è¯•</span></h2>
            <div class="iframe-container">
                <iframe src="index.html" id="game-frame"></iframe>
            </div>
        </div>

        <div class="test-section">
            <h2>1. æ¸¸æˆåˆå§‹åŒ–æµ‹è¯•</h2>
            <p>æ£€æŸ¥æ¸¸æˆæ˜¯å¦æ­£ç¡®åŠ è½½å¹¶åˆå§‹åŒ–</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–</button>
            </div>
            <div class="result" id="result-init">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>2. é”®ç›˜æ§åˆ¶æµ‹è¯•</h2>
            <p>æµ‹è¯•æ–¹å‘é”®æ§åˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testKeyboardControls()">æµ‹è¯•é”®ç›˜æ§åˆ¶</button>
                <button class="test-btn" onclick="sendKey('ArrowUp')">â†‘ å‘ä¸Š</button>
                <button class="test-btn" onclick="sendKey('ArrowDown')">â†“ å‘ä¸‹</button>
                <button class="test-btn" onclick="sendKey('ArrowLeft')">â† å‘å·¦</button>
                <button class="test-btn" onclick="sendKey('ArrowRight')">â†’ å‘å³</button>
                <button class="test-btn" onclick="sendKey('r')">R é‡ç½®</button>
            </div>
            <div class="result" id="result-keyboard">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>3. åˆ†æ•°ç³»ç»Ÿæµ‹è¯•</h2>
            <p>æ£€æŸ¥åˆ†æ•°è®¡ç®—æ˜¯å¦æ­£ç¡®</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testScoring()">æµ‹è¯•åˆ†æ•°è®¡ç®—</button>
                <button class="test-btn" onclick="getScores()">è·å–å½“å‰åˆ†æ•°</button>
            </div>
            <div class="result" id="result-scoring">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>4. æ¸¸æˆç»“æŸæ£€æµ‹æµ‹è¯•</h2>
            <p>æµ‹è¯•æ¸¸æˆç»“æŸçŠ¶æ€çš„æ£€æµ‹</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testGameOver()">æµ‹è¯•æ¸¸æˆç»“æŸ</button>
                <button class="test-btn" onclick="checkGameOverState()">æ£€æŸ¥æ¸¸æˆçŠ¶æ€</button>
            </div>
            <div class="result" id="result-gameover">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>5. UI/åŠŸèƒ½æµ‹è¯•</h2>
            <p>æµ‹è¯•å„ç§UIåŠŸèƒ½</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testRestart()">æµ‹è¯•é‡æ–°å¼€å§‹</button>
                <button class="test-btn" onclick="testInstructions()">æµ‹è¯•æ¸¸æˆè¯´æ˜</button>
                <button class="test-btn" onclick="testSoundToggle()">æµ‹è¯•éŸ³æ•ˆåˆ‡æ¢</button>
            </div>
            <div class="result" id="result-ui">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>6. ç»¼åˆæµ‹è¯•æŠ¥å‘Š</h2>
            <p>è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            </div>
            <div class="result" id="result-all">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('game-frame');
        let testResults = {
            init: false,
            keyboard: false,
            scoring: false,
            gameover: false,
            ui: false
        };

        // ç­‰å¾…iframeåŠ è½½å®Œæˆ
        iframe.addEventListener('load', () => {
            document.getElementById('game-status').textContent = 'å·²åŠ è½½';
            document.getElementById('game-status').className = 'status-badge passed';
        });

        // è·å–æ¸¸æˆå®ä¾‹
        function getGame() {
            try {
                return iframe.contentWindow.game;
            } catch (e) {
                return null;
            }
        }

        // æµ‹è¯•åˆå§‹åŒ–
        function testInitialization() {
            const game = getGame();
            const result = document.getElementById('result-init');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            const checks = [];

            // æ£€æŸ¥æ¸¸æˆå¯¹è±¡
            checks.push(game ? 'æ¸¸æˆå®ä¾‹å­˜åœ¨' : 'æ¸¸æˆå®ä¾‹ä¸å­˜åœ¨');
            checks.push(game.grid ? 'ç½‘æ ¼å­˜åœ¨' : 'ç½‘æ ¼ä¸å­˜åœ¨');
            checks.push(game.score !== undefined ? 'åˆ†æ•°åˆå§‹åŒ–' : 'åˆ†æ•°æœªåˆå§‹åŒ–');
            checks.push(game.fruits ? 'æ°´æœæ•°æ®å­˜åœ¨' : 'æ°´æœæ•°æ®ä¸å­˜åœ¨');
            checks.push(game.elements ? 'DOMå…ƒç´ å­˜åœ¨' : 'DOMå…ƒç´ ä¸å­˜åœ¨');

            // æ£€æŸ¥ç½‘æ ¼å¤§å°
            if (game.grid && game.grid.length === 4 && game.grid[0].length === 4) {
                checks.push('ç½‘æ ¼å¤§å°æ­£ç¡® (4x4)');
            } else {
                checks.push('ç½‘æ ¼å¤§å°é”™è¯¯');
            }

            // æ£€æŸ¥åˆå§‹æ°´æœæ•°é‡
            let fruitCount = 0;
            if (game.grid) {
                for (let r = 0; r < game.grid.length; r++) {
                    for (let c = 0; c < game.grid[r].length; c++) {
                        if (game.grid[r][c]) fruitCount++;
                    }
                }
            }
            checks.push(fruitCount === 2 ? `åˆå§‹æ°´æœæ•°é‡æ­£ç¡® (${fruitCount})` : `åˆå§‹æ°´æœæ•°é‡é”™è¯¯ (${fruitCount})`);

            const passed = checks.filter(c => !c.includes('ä¸å­˜åœ¨') && !c.includes('é”™è¯¯') && !c.includes('æœª')).length;
            const total = checks.length;

            result.innerHTML = `<strong>æµ‹è¯•ç»“æœ: ${passed}/${total} é€šè¿‡</strong><br>` + checks.map(c => `â€¢ ${c}`).join('<br>');
            result.className = passed === total ? 'result pass' : 'result fail';
            testResults.init = passed === total;
        }

        // å‘é€æŒ‰é”®åˆ°æ¸¸æˆ
        function sendKey(key) {
            const game = getGame();
            if (!game) {
                alert('æ¸¸æˆæœªåŠ è½½');
                return;
            }

            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const event = new KeyboardEvent('keydown', {
                key: key,
                bubbles: true,
                cancelable: true
            });
            iframeDoc.dispatchEvent(event);

            document.getElementById('result-keyboard').textContent = `å·²å‘é€æŒ‰é”®: ${key}`;
        }

        // æµ‹è¯•é”®ç›˜æ§åˆ¶
        function testKeyboardControls() {
            const game = getGame();
            const result = document.getElementById('result-keyboard');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            const checks = [];

            // è®°å½•åˆå§‹çŠ¶æ€
            const initialScore = game.score;
            const initialGrid = JSON.stringify(game.grid);

            // æµ‹è¯•æ¯ä¸ªæ–¹å‘
            const directions = ['up', 'down', 'left', 'right'];
            let moved = false;

            directions.forEach(dir => {
                const beforeScore = game.score;
                game.move(dir);
                if (game.score !== beforeScore || game.grid.some((row, r) =>
                    row.some((cell, c) => {
                        const initialCell = JSON.parse(initialGrid)[r][c];
                        return (cell ? cell.level : null) !== (initialCell ? initialCell.level : null);
                    })
                )) {
                    moved = true;
                }
            });

            checks.push(moved ? 'æ–¹å‘é”®æ§åˆ¶æœ‰æ•ˆ' : 'æ–¹å‘é”®æ§åˆ¶æ— æ•ˆ');
            checks.push(game.elements.board ? 'æ¸¸æˆæ¿å­˜åœ¨' : 'æ¸¸æˆæ¿ä¸å­˜åœ¨');
            checks.push('æ‰€æœ‰æ–¹å‘é”®æµ‹è¯•å®Œæˆ');

            const passed = checks.filter(c => !c.includes('æ— æ•ˆ') && !c.includes('ä¸å­˜åœ¨')).length;
            result.innerHTML = `<strong>æµ‹è¯•ç»“æœ: ${passed}/${checks.length} é€šè¿‡</strong><br>` + checks.map(c => `â€¢ ${c}`).join('<br>');
            result.className = passed === checks.length ? 'result pass' : 'result fail';
            testResults.keyboard = passed === checks.length;
        }

        // è·å–å½“å‰åˆ†æ•°
        function getScores() {
            const game = getGame();
            if (!game) {
                alert('æ¸¸æˆæœªåŠ è½½');
                return;
            }

            document.getElementById('result-scoring').innerHTML =
                `å½“å‰åˆ†æ•°: ${game.score}<br>æœ€é«˜åˆ†æ•°: ${game.bestScore}`;
        }

        // æµ‹è¯•åˆ†æ•°è®¡ç®—
        function testScoring() {
            const game = getGame();
            const result = document.getElementById('result-scoring');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            const checks = [];

            // é‡ç½®æ¸¸æˆ
            game.reset();
            const initialScore = game.score;
            checks.push(initialScore === 0 ? `åˆå§‹åˆ†æ•°ä¸º0` : `åˆå§‹åˆ†æ•°ä¸º${initialScore}`);

            // è¿›è¡Œä¸€äº›ç§»åŠ¨æ¥è·å–åˆ†æ•°
            for (let i = 0; i < 10; i++) {
                const directions = ['up', 'down', 'left', 'right'];
                game.move(directions[Math.floor(Math.random() * 4)]);
            }

            const finalScore = game.score;
            checks.push(finalScore > 0 ? `åˆ†æ•°å¢åŠ æœ‰æ•ˆ (å½“å‰: ${finalScore})` : `åˆ†æ•°æœªå¢åŠ `);

            // æ£€æŸ¥æœ€é«˜åˆ†
            if (finalScore > game.bestScore) {
                checks.push(`æœ€é«˜åˆ†æ›´æ–°æ­£ç¡®`);
            } else {
                checks.push(`å½“å‰åˆ†æ•°ä¸è¶…è¿‡æœ€é«˜åˆ†`);
            }

            const passed = checks.filter(c => !c.includes('æœª') && !c.includes('é”™è¯¯')).length;
            result.innerHTML = `<strong>æµ‹è¯•ç»“æœ: ${passed}/${checks.length} é€šè¿‡</strong><br>` + checks.map(c => `â€¢ ${c}`).join('<br>');
            result.className = passed === checks.length ? 'result pass' : 'result fail';
            testResults.scoring = passed === checks.length;
        }

        // æµ‹è¯•æ¸¸æˆç»“æŸæ£€æµ‹
        function testGameOver() {
            const game = getGame();
            const result = document.getElementById('result-gameover');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            const checks = [];

            // é‡ç½®æ¸¸æˆ
            game.reset();
            checks.push(!game.gameOver ? 'æ¸¸æˆé‡ç½®åæœªç»“æŸ' : 'æ¸¸æˆé‡ç½®åå·²ç»“æŸ');

            // æ£€æŸ¥æ¸¸æˆç»“æŸæ£€æµ‹å‡½æ•°
            checks.push(typeof game.checkState === 'function' ? 'checkStateæ–¹æ³•å­˜åœ¨' : 'checkStateæ–¹æ³•ä¸å­˜åœ¨');
            checks.push(typeof game.showGameOver === 'function' ? 'showGameOveræ–¹æ³•å­˜åœ¨' : 'showGameOveræ–¹æ³•ä¸å­˜åœ¨');

            const passed = checks.filter(c => !c.includes('ä¸å­˜åœ¨') && !c.includes('å·²ç»“æŸ')).length;
            result.innerHTML = `<strong>æµ‹è¯•ç»“æœ: ${passed}/${checks.length} é€šè¿‡</strong><br>` + checks.map(c => `â€¢ ${c}`).join('<br>');
            result.className = passed === checks.length ? 'result pass' : 'result fail';
            testResults.gameover = passed === checks.length;
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸçŠ¶æ€
        function checkGameOverState() {
            const game = getGame();
            const result = document.getElementById('result-gameover');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            result.innerHTML =
                `æ¸¸æˆç»“æŸçŠ¶æ€: ${game.gameOver ? 'æ˜¯' : 'å¦'}<br>` +
                `å½“å‰åˆ†æ•°: ${game.score}<br>` +
                `æœ€é«˜åˆ†æ•°: ${game.bestScore}`;
        }

        // æµ‹è¯•é‡æ–°å¼€å§‹
        function testRestart() {
            const game = getGame();
            const result = document.getElementById('result-ui');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            game.reset();
            const checks = [];
            checks.push(!game.gameOver ? 'é‡ç½®åæ¸¸æˆæœªç»“æŸ' : 'é‡ç½®åæ¸¸æˆå·²ç»“æŸ');
            checks.push(game.score === 0 ? 'é‡ç½®ååˆ†æ•°ä¸º0' : `é‡ç½®ååˆ†æ•°ä¸º${game.score}`);

            // è®¡ç®—æ°´æœæ•°é‡
            let fruitCount = 0;
            for (let r = 0; r < game.grid.length; r++) {
                for (let c = 0; c < game.grid[r].length; c++) {
                    if (game.grid[r][c]) fruitCount++;
                }
            }
            checks.push(fruitCount === 2 ? `é‡ç½®åæœ‰2ä¸ªæ°´æœ` : `é‡ç½®åæœ‰${fruitCount}ä¸ªæ°´æœ`);

            result.innerHTML = `<strong>é‡æ–°å¼€å§‹æµ‹è¯•:</strong><br>` + checks.map(c => `â€¢ ${c}`).join('<br>');
            result.className = checks.every(c => !c.includes('å·²ç»“æŸ') && !c.includes('ä¸º') || c.includes('0') || c.includes('2ä¸ª')) ? 'result pass' : 'result fail';
        }

        // æµ‹è¯•æ¸¸æˆè¯´æ˜
        function testInstructions() {
            const game = getGame();
            const result = document.getElementById('result-ui');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            if (game.elements.instructionsModal) {
                game.elements.instructionsModal.classList.add('active');
                result.innerHTML = `<strong>æ¸¸æˆè¯´æ˜æ¨¡æ€æ¡†:</strong> å·²æ‰“å¼€<br>è¯·æ£€æŸ¥iframeä¸­æ˜¯å¦æ˜¾ç¤ºæ¸¸æˆè¯´æ˜`;
                setTimeout(() => {
                    game.elements.instructionsModal.classList.remove('active');
                }, 2000);
            } else {
                result.innerHTML = `<strong>æ¸¸æˆè¯´æ˜æ¨¡æ€æ¡†:</strong> ä¸å­˜åœ¨`;
            }
        }

        // æµ‹è¯•éŸ³æ•ˆåˆ‡æ¢
        function testSoundToggle() {
            const game = getGame();
            const result = document.getElementById('result-ui');

            if (!game) {
                result.textContent = 'âœ— æ¸¸æˆæœªåŠ è½½';
                result.className = 'result fail';
                return;
            }

            game.toggleSound();
            result.innerHTML = `<strong>éŸ³æ•ˆåˆ‡æ¢:</strong> å½“å‰çŠ¶æ€: ${game.soundEnabled ? 'å¼€å¯' : 'å…³é—­'}`;
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            const result = document.getElementById('result-all');
            result.innerHTML = 'æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...';

            testResults = {
                init: false,
                keyboard: false,
                scoring: false,
                gameover: false,
                ui: false
            };

            // ä¾æ¬¡è¿è¡Œæµ‹è¯•
            testInitialization();
            await sleep(500);

            testKeyboardControls();
            await sleep(500);

            testScoring();
            await sleep(500);

            testGameOver();
            await sleep(500);

            testRestart();
            await sleep(500);

            // ç”ŸæˆæŠ¥å‘Š
            const passed = Object.values(testResults).filter(v => v).length;
            const total = Object.keys(testResults).length;

            let report = `<strong>ç»¼åˆæµ‹è¯•æŠ¥å‘Š: ${passed}/${total} é€šè¿‡</strong><br><br>`;
            report += `â€¢ åˆå§‹åŒ–æµ‹è¯•: ${testResults.init ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}<br>`;
            report += `â€¢ é”®ç›˜æ§åˆ¶æµ‹è¯•: ${testResults.keyboard ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}<br>`;
            report += `â€¢ åˆ†æ•°ç³»ç»Ÿæµ‹è¯•: ${testResults.scoring ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}<br>`;
            report += `â€¢ æ¸¸æˆç»“æŸæ£€æµ‹: ${testResults.gameover ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}<br>`;
            report += `â€¢ UIåŠŸèƒ½æµ‹è¯•: ${testResults.ui ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}<br><br>`;

            if (passed === total) {
                report += `<strong style="color: #10b981;">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ¸¸æˆåŠŸèƒ½æ­£å¸¸ã€‚</strong>`;
            } else {
                report += `<strong style="color: #ef4444;">âš ï¸ æœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›¸å…³åŠŸèƒ½ã€‚</strong>`;
            }

            result.innerHTML = report;
            result.className = passed === total ? 'result pass' : 'result fail';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
