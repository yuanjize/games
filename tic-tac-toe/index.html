<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="智能井字棋游戏，挑战不同难度的AI对手。支持键盘导航、屏幕阅读器和触摸设备。">
    <meta name="keywords" content="井字棋,TicTacToe,AI游戏,可访问性游戏,HTML5游戏">
    <meta name="author" content="智能井字棋游戏开发者">
    <title>智能井字棋 - X vs AI | 可访问性优化的井字棋游戏</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pIVpG8hZ5ZcVZL2Q6nNZb/KEVmXWpHFAIqOjDBNRIjpkZYqBq/8mcZaGAgIWjjKYB0QGM0RJeBExE2G0bUEw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <a href="#main-content" class="skip-link">跳转到主要内容</a>

    <!-- 加载动画覆盖层 -->
    <div class="loading-overlay" id="loadingOverlay" role="status" aria-live="polite" aria-label="游戏正在加载">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-gamepad" style="color: var(--color-primary);"></i>
            </div>
            <p class="loading-text">智能井字棋加载中...</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p class="progress-text" id="progressText">0%</p>
        </div>
    </div>

    <!-- 手势帮助提示 -->
    <div class="gesture-hint" id="gestureHint" role="status" aria-live="polite">
        <i class="fas fa-hand-pointer"></i>
        <span id="gestureHintText">长按棋盘查看帮助</span>
    </div>

    <!-- 长按帮助菜单 -->
    <div class="long-press-menu" id="longPressMenu" role="dialog" aria-label="游戏帮助">
        <h4><i class="fas fa-question-circle"></i> 游戏帮助</h4>
        <ul role="list">
            <li role="listitem"><i class="fas fa-hand-pointer"></i> 点击格子下棋</li>
            <li role="listitem"><i class="fas fa-hand-paper"></i> 双指触摸暂停游戏</li>
            <li role="listitem"><i class="fas fa-clock"></i> 长按查看此帮助</li>
            <li role="listitem"><i class="fas fa-keyboard"></i> 使用方向键导航</li>
            <li role="listitem"><i class="fas fa-lightbulb"></i> 按H键获取提示</li>
        </ul>
    </div>

    <!-- 彩带容器 -->
    <div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

    <div class="container" role="main" aria-label="井字棋游戏">
        <header class="header" role="banner">
            <a href="../index.html" class="back-button" aria-label="返回游戏大厅">
                <i class="fas fa-arrow-left" aria-hidden="true"></i> 返回游戏大厅
            </a>
            <h1><i class="fas fa-gamepad" aria-hidden="true"></i> 智能井字棋</h1>
            <p class="subtitle">挑战不同难度的AI对手</p>

            <!-- 主题和对比度切换按钮 -->
            <div class="header-controls">
                <button class="contrast-toggle-btn" id="contrastToggle" aria-label="切换高对比度模式" aria-pressed="false">
                    <i class="fas fa-adjust" aria-hidden="true"></i>
                </button>
                <button class="theme-toggle-btn" id="themeToggle" aria-label="切换亮色/暗色主题">
                    <i class="fas fa-moon" aria-hidden="true"></i>
                </button>
            </div>
        </header>

        <main class="game-container" id="main-content" aria-label="游戏区域">
            <section class="game-sidebar" aria-label="游戏信息和历史">
                <div class="game-info" role="region" aria-label="游戏信息面板">
                    <div class="player-turn" aria-live="polite" aria-atomic="true">
                        <div class="player-icon player-x" role="img" aria-label="玩家X的图标">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </div>
                        <div class="turn-text">
                            <span class="turn-label">当前回合:</span>
                            <span id="currentPlayer" class="player-name" role="status" aria-live="polite">玩家 X</span>
                        </div>
                    </div>

                    <div class="game-status" role="region" aria-label="游戏状态">
                        <h3><i class="fas fa-info-circle" aria-hidden="true"></i> 游戏状态</h3>
                        <div id="statusText" class="status-text" role="alert" aria-live="assertive">
                            <span id="statusMainText">游戏进行中</span>
                            <span id="aiThinking" class="ai-thinking" style="display: none;">
                                <span class="ai-thinking-dots">
                                    <span class="ai-thinking-dot"></span>
                                    <span class="ai-thinking-dot"></span>
                                    <span class="ai-thinking-dot"></span>
                                </span>
                            </span>
                        </div>
                    </div>

                    <div class="stats" role="region" aria-label="游戏统计">
                        <h3><i class="fas fa-chart-bar" aria-hidden="true"></i> 统计</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">玩家胜利:</span>
                                <span id="playerWins" class="stat-value" role="status" aria-live="polite">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">AI胜利:</span>
                                <span id="aiWins" class="stat-value" role="status" aria-live="polite">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">平局:</span>
                                <span id="draws" class="stat-value" role="status" aria-live="polite">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">总局数:</span>
                                <span id="totalGames" class="stat-value" role="status" aria-live="polite">0</span>
                            </div>
                        </div>
                        <div class="stats-controls">
                            <button id="resetStatsBtn" class="control-btn small" aria-label="重置游戏统计">
                                <i class="fas fa-redo" aria-hidden="true"></i> 重置统计
                            </button>
                        </div>
                    </div>
                </div>

                <div class="history-section" role="region" aria-label="走棋历史">
                    <h3><i class="fas fa-history" aria-hidden="true"></i> 走棋历史</h3>
                    <div id="historyList" class="history-list" role="log" aria-live="polite">
                        <div class="history-empty">尚未开始游戏</div>
                    </div>
                </div>
            </section>

            <section class="game-board-section" aria-label="游戏棋盘区域">
                <div class="difficulty-selector" role="group" aria-labelledby="difficulty-heading">
                    <h3 id="difficulty-heading"><i class="fas fa-robot" aria-hidden="true"></i> AI难度选择</h3>
                    <div class="difficulty-buttons">
                        <button class="difficulty-btn active" data-difficulty="easy" aria-pressed="true">
                            <i class="fas fa-baby" aria-hidden="true"></i> 简单 (随机)
                        </button>
                        <button class="difficulty-btn" data-difficulty="medium" aria-pressed="false">
                            <i class="fas fa-user-graduate" aria-hidden="true"></i> 中等 (策略)
                        </button>
                        <button class="difficulty-btn" data-difficulty="hard" aria-pressed="false">
                            <i class="fas fa-brain" aria-hidden="true"></i> 困难 (Minimax)
                        </button>
                    </div>
                    <div class="difficulty-description">
                        <p id="difficultyDesc" role="status" aria-live="polite">简单模式：AI随机走棋，适合初学者。</p>
                    </div>
                </div>

                <div class="game-board-container" role="region" aria-label="游戏棋盘">
                    <div class="board" id="board" role="grid" aria-label="井字棋棋盘" aria-rowcount="3" aria-colcount="3">
                        <!-- 棋盘格子将通过JavaScript动态生成，每个格子都有role="gridcell" -->
                    </div>

                    <div class="board-controls" role="toolbar" aria-label="棋盘控制工具栏">
                        <button id="newGameBtn" class="control-btn primary" aria-label="开始新游戏">
                            <i class="fas fa-play-circle" aria-hidden="true"></i> 新游戏
                        </button>
                        <button id="undoBtn" class="control-btn secondary" aria-label="悔棋（撤销上一步）">
                            <i class="fas fa-undo" aria-hidden="true"></i> 悔棋
                        </button>
                        <button id="hintBtn" class="control-btn secondary" aria-label="显示提示（建议下一步）">
                            <i class="fas fa-lightbulb" aria-hidden="true"></i> 提示
                        </button>
                        <button id="soundToggle" class="control-btn secondary sound-on" aria-label="音效开关（当前开启）" aria-pressed="true">
                            <i class="fas fa-volume-up" aria-hidden="true"></i> 音效
                        </button>
                    </div>
                </div>
            </section>

            <aside class="game-tutorial" aria-label="游戏教程和说明">
                <h3><i class="fas fa-graduation-cap" aria-hidden="true"></i> 游戏说明</h3>
                <div class="tutorial-content" role="region" aria-label="游戏步骤说明">
                    <div class="tutorial-step">
                        <div class="step-number" aria-hidden="true">1</div>
                        <div class="step-text">选择AI难度级别（简单、中等、困难）</div>
                    </div>
                    <div class="tutorial-step">
                        <div class="step-number" aria-hidden="true">2</div>
                        <div class="step-text">点击棋盘上的格子放置"X"（玩家）</div>
                    </div>
                    <div class="tutorial-step">
                        <div class="step-number" aria-hidden="true">3</div>
                        <div class="step-text">AI会自动放置"O"作为回应</div>
                    </div>
                    <div class="tutorial-step">
                        <div class="step-number" aria-hidden="true">4</div>
                        <div class="step-text">率先将三个相同标记连成一线（横、竖、斜）者获胜</div>
                    </div>
                    <div class="tutorial-step">
                        <div class="step-number" aria-hidden="true">5</div>
                        <div class="step-text">棋盘填满而无获胜者时为平局</div>
                    </div>
                </div>

                <div class="ai-info" role="region" aria-label="AI算法说明">
                    <h4><i class="fas fa-cogs" aria-hidden="true"></i> AI算法说明</h4>
                    <ul role="list">
                        <li role="listitem"><strong>简单</strong>: 随机选择一个空位，适合初学者</li>
                        <li role="listitem"><strong>中等</strong>: 基于基本策略，会尝试阻挡和进攻</li>
                        <li role="listitem"><strong>困难</strong>: 使用Minimax算法，不可战胜（最优策略）</li>
                    </ul>
                </div>
            </aside>
        </main>

        <footer class="footer" role="contentinfo">
            <p>智能井字棋游戏 &copy; 2025 | 使用原生JavaScript、HTML和CSS开发</p>
            <p class="footer-links">
                <span>快捷键：空格键 - 新游戏 | R - 悔棋 | H - 提示 | 1/2/3 - 切换难度</span>
            </p>
        </footer>
    </div>

    <!-- 音频元素 - 使用Web Audio API生成高质量音效 -->
    <script>
        // 创建增强的音频上下文用于生成高质量音效
        (function() {
            window.gameAudio = {
                ctx: null,
                masterGain: null,
                init: function() {
                    if (!this.ctx) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.ctx = new AudioContext();

                        // 创建主音量控制
                        this.masterGain = this.ctx.createGain();
                        this.masterGain.gain.value = 0.3; // 默认音量
                        this.masterGain.connect(this.ctx.destination);
                    }
                    // 恢复音频上下文（浏览器自动播放策略）
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                    }
                },

                // 播放点击音效 - 高音短促
                playClick: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();

                        osc.connect(gain);
                        gain.connect(this.masterGain);

                        // 使用三角波获得更清脆的声音
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(800, t);
                        osc.frequency.exponentialRampToValueAtTime(400, t + 0.1);

                        gain.gain.setValueAtTime(0.3, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);

                        osc.start(t);
                        osc.stop(t + 0.15);
                    } catch (e) {
                        console.debug('播放点击音效失败:', e);
                    }
                },

                // 播放 X 棋子音效
                playX: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();

                        osc.connect(gain);
                        gain.connect(this.masterGain);

                        osc.type = 'square';
                        osc.frequency.setValueAtTime(600, t);
                        osc.frequency.exponentialRampToValueAtTime(300, t + 0.15);

                        gain.gain.setValueAtTime(0.2, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);

                        osc.start(t);
                        osc.stop(t + 0.2);
                    } catch (e) {
                        console.debug('播放X音效失败:', e);
                    }
                },

                // 播放 O 棋子音效
                playO: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();

                        osc.connect(gain);
                        gain.connect(this.masterGain);

                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(400, t);
                        osc.frequency.exponentialRampToValueAtTime(600, t + 0.15);

                        gain.gain.setValueAtTime(0.2, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);

                        osc.start(t);
                        osc.stop(t + 0.2);
                    } catch (e) {
                        console.debug('播放O音效失败:', e);
                    }
                },

                // 播放胜利音效 - 欢快的旋律
                playWin: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        // C大调琶音：C5, E5, G5, C6
                        const notes = [523.25, 659.25, 783.99, 1046.50];
                        const durations = [0.15, 0.15, 0.15, 0.3];

                        notes.forEach((freq, i) => {
                            const startTime = t + i * 0.15;
                            const osc = this.ctx.createOscillator();
                            const gain = this.ctx.createGain();

                            osc.connect(gain);
                            gain.connect(this.masterGain);

                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(freq, startTime);

                            const duration = durations[i];
                            gain.gain.setValueAtTime(0, startTime);
                            gain.gain.linearRampToValueAtTime(0.25, startTime + 0.02);
                            gain.gain.setValueAtTime(0.2, startTime + duration * 0.7);
                            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                            osc.start(startTime);
                            osc.stop(startTime + duration);
                        });
                    } catch (e) {
                        console.debug('播放胜利音效失败:', e);
                    }
                },

                // 播放失败音效 - 低沉的旋律
                playLose: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        // 下降音阶
                        const notes = [392, 349.23, 329.63, 293.66, 261.63];
                        const durations = [0.2, 0.2, 0.2, 0.2, 0.4];

                        notes.forEach((freq, i) => {
                            const startTime = t + i * 0.2;
                            const osc = this.ctx.createOscillator();
                            const gain = this.ctx.createGain();

                            osc.connect(gain);
                            gain.connect(this.masterGain);

                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(freq, startTime);

                            const duration = durations[i];
                            gain.gain.setValueAtTime(0, startTime);
                            gain.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
                            gain.gain.setValueAtTime(0.15, startTime + duration * 0.6);
                            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                            osc.start(startTime);
                            osc.stop(startTime + duration);
                        });
                    } catch (e) {
                        console.debug('播放失败音效失败:', e);
                    }
                },

                // 播放平局音效
                playDraw: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        // 平和的音调
                        const notes = [440, 440];
                        const durations = [0.2, 0.3];

                        notes.forEach((freq, i) => {
                            const startTime = t + i * 0.25;
                            const osc = this.ctx.createOscillator();
                            const gain = this.ctx.createGain();

                            osc.connect(gain);
                            gain.connect(this.masterGain);

                            osc.type = 'triangle';
                            osc.frequency.setValueAtTime(freq, startTime);

                            const duration = durations[i];
                            gain.gain.setValueAtTime(0.15, startTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                            osc.start(startTime);
                            osc.stop(startTime + duration);
                        });
                    } catch (e) {
                        console.debug('播放平局音效失败:', e);
                    }
                },

                // 播放提示音效
                playHint: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();

                        osc.connect(gain);
                        gain.connect(this.masterGain);

                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(880, t);
                        osc.frequency.setValueAtTime(1100, t + 0.1);

                        gain.gain.setValueAtTime(0, t);
                        gain.gain.linearRampToValueAtTime(0.15, t + 0.02);
                        gain.gain.setValueAtTime(0.1, t + 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.25);

                        osc.start(t);
                        osc.stop(t + 0.25);
                    } catch (e) {
                        console.debug('播放提示音效失败:', e);
                    }
                },

                // 播放悔棋音效
                playUndo: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();

                        osc.connect(gain);
                        gain.connect(this.masterGain);

                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(300, t);
                        osc.frequency.exponentialRampToValueAtTime(150, t + 0.2);

                        gain.gain.setValueAtTime(0.15, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);

                        osc.start(t);
                        osc.stop(t + 0.2);
                    } catch (e) {
                        console.debug('播放悔棋音效失败:', e);
                    }
                },

                // 播放主题切换音效
                playThemeChange: function() {
                    try {
                        this.init();
                        const t = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();

                        osc.connect(gain);
                        gain.connect(this.masterGain);

                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(600, t);
                        osc.frequency.exponentialRampToValueAtTime(900, t + 0.15);

                        gain.gain.setValueAtTime(0.1, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);

                        osc.start(t);
                        osc.stop(t + 0.15);
                    } catch (e) {
                        console.debug('播放主题切换音效失败:', e);
                    }
                },

                // 设置音量
                setVolume: function(value) {
                    this.init();
                    this.masterGain.gain.value = Math.max(0, Math.min(1, value));
                },

                // 获取音量
                getVolume: function() {
                    return this.masterGain ? this.masterGain.gain.value : 0.3;
                }
            };
        })();
    </script>

    <script src="game.js"></script>
</body>
</html>
